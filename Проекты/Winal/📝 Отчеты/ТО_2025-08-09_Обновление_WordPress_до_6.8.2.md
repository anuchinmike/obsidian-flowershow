# Техническое обслуживание: обновление WordPress и плагинов (продакшн)

- Дата и время: 2025-08-09 (MSK)
- Сайт: https://winal.ru
- Окружение: продакшн
- Ответственный: системный отчёт (авто)

## Результат

- WordPress обновлён до версии 6.8.2.
- Плагины: Gravity Forms 2.9.14; Meta Box; Meta Box AIO 2.3.1; Max Mega Menu 3.6.2; Post Types Order 2.3.7; Simple Custom Post Order 2.5.11 (деактивирован); Taxonomy Terms Order 1.9; FileBird Pro 6.4.9; Gravity Forms hCaptcha — установлен.
- Во всех формах заменено поле Simple Captcha на hCaptcha.
- Критических ошибок (Fatal/Parse) не выявлено.
- Ошибка jQuery «$ is not a function» устранена (отключён инлайн-скрипт в футере).

## Детали выполненных действий

1. Проверка версии ядра WordPress

- Файл `wp-includes/version.php` содержит `$wp_version = '6.8.2';` — версия подтверждена.

2. Быстрые проверки фронтенда (открытие страниц, консоль браузера)

- Главная, каталог, контакты — без JS-ошибок в консоли; остаются служебные сообщения jQuery Migrate и виджетов.

3. Проверка логов

- Серверный лог `winal.ru.error.log`: без новых записей.
- Лог WordPress `wp-content/debug.log`: без новых записей, связанных с установкой/работой hCaptcha.

4. Сигналы со стейджинга (для сведения)

- В среде `winal.magency.su` встречаются аналогичные предупреждения темы. На проде — без критичных ошибок.

## Внесённые изменения по безопасности/антиспаму

- Полностью удалён внешний скрипт из папки `Bx24/order.php`, написанный сторонними «специалистами по Битрикс24`:
  - Открывал уязвимости (принимал произвольные запросы),
  - содержал открытые ключи/URL веб‑хука Bitrix24, что ставило под угрозу сайт и данные CRM,
  - дублировал функциональность форм и ломал фронтенд (вызвал ошибку `TypeError: $ is not a function`).
- Отправка заявок реализована корректно внутри темы, в `functions.php`, через серверный хук Gravity Forms (`gform_after_submission`) и официальный REST Bitrix24 (webhook). Доступы и логика скрыты от фронтенда.
- Во все формы внедрена `hCaptcha` вместо устаревшего Simple Captcha.

## Улучшения форм и данных для CRM

- Добавлено поле «Город» (Parameter Name = `city`) и передача в сделку Битрикс24 полю `UF_CRM_5FB2963C5FDA6` («Адрес или город»).
- Включена проверка телефона на сервере:
  - Поддерживаются РФ и страны СНГ: +7 (РФ/КЗ), +375, +374, +994, +996, +992, +993, +998, +373.
  - Допустимы локальные формы для РФ/КЗ: `8XXXXXXXXXX`, `7XXXXXXXXXX`, `XXXXXXXXXX`.
  - Автонормализация к формату E.164 (например, `8 999 123‑45‑67` → `+79991234567`). Это уменьшит дубли в CRM и повысит качество поиска контактов.
  - По запросу можно ограничить только РФ (+7).
- Трекинг-данные:
  - UTM, `yclid`, `gclid`, `referrer`, `landing_url` — сохраняются в cookies и автоматически подхватываются на сервере при отправке формы;
  - `ym_client_id` сохраняется на клиенте через `ym(counter,'getClientID', ...)` в cookie и отправляется в CRM;
  - все коды дублируются в «читаемые» поля (`UF_CRM_YCLID`, `UF_CRM_GCLID`, `UF_CRM_YM_CLIENT_ID`) и в реальные UF‑коды Bitrix24 (`UF_CRM_1754658797`, `UF_CRM_1754658844`, `UF_CRM_1754658829`).
- Источник сделки: установлено встроенное поле `SOURCE_ID = WEB` («Веб‑сайт»).

## Обнаруженные проблемы в логах (wp-content/debug.log)

- На продакшне критичных PHP‑ошибок (Fatal/Parse) и новых предупреждений не зафиксировано.
- Предупреждения темы/плагинов, замеченные ранее на стейджинге, на прод не воспроизводятся.

## Замена WP-Optimize → W3 Total Cache (ранее зафиксировано)

- Причина замены: шум и ошибки обновлятора премиум‑модуля WP-Optimize.
- Статус: WP-Optimize отключён; план — внедрить W3 Total Cache после финальной проверки совместимости.

## Проверка после обновлений плагинов

- Gravity Forms 2.9.14: серверный лог/`debug.log`/консоль — без ошибок.
- Meta Box + Meta Box AIO 2.3.1: критичных ошибок нет; Notice о ранней загрузке переводов `meta-box-aio` сохраняются.
- Max Mega Menu 3.6.2: консоль и серверный лог — без ошибок; в `debug.log` остаются Notice о ранней загрузке переводов `megamenu-pro` (низкая важность).
- Post Types Order 2.3.7: серверный лог/`debug.log`/консоль — без ошибок.
- Simple Custom Post Order 2.5.11: деактивирован для исключения дублирования с PTO/TTO.
- Taxonomy Terms Order 1.9: серверный лог/`debug.log`/консоль — без ошибок.
- FileBird Pro 6.4.9: серверный лог/`debug.log`/консоль — без ошибок.
- Gravity Forms hCaptcha: серверный лог/`debug.log`/консоль — без ошибок.

## Анализ дублирования функций сортировки

- Post Types Order (PTO): сортирует записи/CPT через `menu_order` — хуки `pre_get_posts`, `posts_orderby`.
- Simple Custom Post Order (SCPO): сортирует записи и термины — хуки `pre_get_posts`, `get_terms_orderby`, `wp_get_object_terms`.
- Taxonomy Terms Order (TTO): сортирует термины/категории — хуки `terms_clauses`, `get_terms_orderby`.

Вывод: SCPO пересекается и с PTO (по записям), и с TTO (по терминам). Возможны конкурирующие фильтры порядка при включённых «Autosort» сразу в нескольких плагинах.

Рекомендации:

- Для записей: использовать PTO как основной; SCPO — отключён.
- Для таксономий: использовать TTO как основной; сортировку терминов в иных плагинах — не активировать.
- Проверить выборки с явным `orderby`, чтобы не перезаписывать пользовательский порядок плагинами.

## Выводы

- Ядро и плагины работают без критичных ошибок.
- Усилена безопасность: удалён уязвимый фронтенд‑скрипт Битрикс24, логика перенесена на сервер, ключи спрятаны.
- Формы дополнены полем «Город», телефоны валидируются и нормализуются (E.164), трекинг‑данные сохраняются и передаются в CRM.
- Остались некритичные Notice/Deprecated/Warning от ряда плагинов и темы.

## Рекомендации и план работ

- Перенесено в конец отчёта (см. ниже).

---

## Соответствие 152‑ФЗ

- В отчёте отсутствуют персональные данные; только технические данные и публичные URL.

---

Отчёт обновлён: добавлены антиспам‑работы (удаление уязвимого скрипта, перенос логики в `functions.php`), поле «Город», валидация/нормализация телефонов, источник сделки `SOURCE_ID=WEB`, трекинг `ym_client_id` в cookie.

## Аудит безопасности — выполнено 

- Ядро WordPress и плагины обновлены. Это базовая защита от известных уязвимостей.
- Опасный внешний скрипт интеграции с Битрикс удалён, логика перенесена на серверную сторону. Ключи и адреса веб‑хука не видны посетителям.
- Сайт работает по защищённому протоколу HTTPS. Проверили валидность сертификата; трафик шифруется.
- Проверили типичные точки атаки (ввод опасных параметров в адресной строке, попытки доступа к конфигурационным файлам, бэкапам). Сервер отвечает корректно кодами 401/403/404; критичных ошибок 5xx нет. Примеры отражены в access‑логе.
- Включены и настроены средства защиты:
  - `hCaptcha` на формах — отфильтровывает ботов до отправки формы.
  - Удаление рекламных меток из URL с автоматическим 301‑редиректом — предотвращает появление дублей страниц и мусорных ссылок.
  - Закрыты служебные разделы и файлы в `robots.txt`; индексация «мусорных» страниц запрещена.
- Провели базовую проверку прав доступа к файлам/папкам и отсутствия публичных бэкапов. Критичных нарушений не найдено.
- REST‑перечисление пользователей и прямые вызовы уязвимых путей блокируются (видим 401/403 в логах на такие попытки).
- Логи ошибок сервера «чистые»: новых PHP‑ошибок уровня Fatal/Warning/Deprecated на продакшне не зафиксировано.

Итог: критичных рисков безопасности не обнаружено, базовые меры защиты включены. Рекомендации по усилению на будущее — в конце отчёта (заголовок «Рекомендации и план работ (актуально)»).

## Отдельные закрытые задачи (по плану «Общий список задач 7 июля – 7 августа 2025»)

- Обновление WordPress ядра до 6.8.2 — выполнено.
- Обновление плагинов — выполнено (см. перечень выше).
- Антиспам и безопасность форм — выполнено полностью:
  - Полностью удалён уязвимый фронтенд‑скрипт `Bx24/order.php`, ключи Б24 вынесены из фронта.
  - Отправка заявок переносена в `functions.php` через `gform_after_submission` + веб‑хук Bitrix24.
  - Во всех формах включена `hCaptcha`.
  - Добавлено поле «Город» (`city`) и передача в `UF_CRM_5FB2963C5FDA6`.
  - Добавлена серверная проверка и нормализация телефонов (РФ + СНГ → E.164). По запросу можно оставить только РФ.
  - Сохранение UTM/click/referrer/landing в cookies и проброс в сделку; `ym_client_id` фиксируется на клиенте и отправляется в CRM.
  - Источник сделки — `SOURCE_ID=WEB` («Веб‑сайт»).
- Проверка и модификация `robots.txt` — выполнено. Дубли с GET‑параметрами устранены (см. `🛠️ Задачи по сайту/Ошибки robots.txt.md`).
- SEO‑плагин заменён: All in One SEO → Rank Math SEO — выполнено.

## Кеширование и производительность (W3 Total Cache)

- Включено `WP_CACHE` в `wp-config.php`.
- Установлен и настроен W3 Total Cache:
  - Page Cache: ON (Disk: Enhanced), исключения: `wp-admin`, `wp-login.php`, `wp-json`, превью, поиск, страницы с формами.
  - Object Cache: ON (Memcached, 127.0.0.1:11211).
  - Database Cache: ON (Memcached, 127.0.0.1:11211).
  - Browser Cache: ON (Expires/Cache-Control/Last-Modified включены; длительные сроки для статики).
  - Minify: OFF (включим после регресса).
- Примечание: Memcached на Beget — платная опция, ~2 руб/день.
- Очистка кэша выполнена после применения настроек.

## SEO

- Плагин All in One SEO удалён/заменён на Rank Math SEO (активен). Настроены базовые метаданные, sitemap, интеграция robots.txt с текущими правилами.
- `robots.txt` — проверен и обновлён под текущую структуру сайта (индексация основных разделов, запрет служебных путей).

---

## Рекомендации и план работ (актуально)

- Отключить отладку на прод: `WP_DEBUG=false`, выключить запись в `debug.log` после завершения работ.
- Укрепление безопасности:
  - 2FA для админов; ревизия прав.
  - HTTP‑заголовки: HSTS, nosniff, frame‑options, referrer‑policy, permissions‑policy, CSP (report‑only).
  - Ограничение попыток входа, актуальная конфигурация Wordfence.
- Обслуживание инфраструктуры:
  - Регулярные резервные копии (файлы + БД) и тест восстановления; ротация бэкапов.
  - Перевод `WP-Cron` на системный cron.
  - Ротация/чистка логов.
- Производительность и SEO‑гигиена:
  - После регресса аккуратно включить Minify (CSS/JS) в W3TC и протестировать фронтенд.
  - Оптимизация критического CSS/JS (defer, preload шрифтов), lazy‑load фоновых изображений.
  - Проверка sitemap/каноникалей, отсутствие дублей с параметрами.
- Соответствие 152‑ФЗ:
  - Минимизировать собираемые персональные поля; сроки хранения cookie; актуализировать политику конфиденциальности.
